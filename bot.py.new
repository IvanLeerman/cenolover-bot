import asyncio
import json
import logging
import pytz
from typing import Dict, List, Optional
from datetime import datetime, timedelta

from aiogram import Bot, Dispatcher, types
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.utils import executor
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from aiogram.dispatcher import FSMContext
from aiogram.dispatcher.filters.state import State, StatesGroup

from config import (
    API_TOKEN, DB_URI, AUCTION_CHANNEL, TIMEZONE, MIN_STEP,
    AUCTION_DURATION_HOURS, EXTEND_THRESHOLD_MIN, EXTEND_TO_MIN,
    PAYMENT_TIMEOUT_MIN, MAX_UNPAID_WARNINGS, BAN_DAYS, ADMIN_IDS
)
from async_db import AsyncDatabase
from rate_limit import setup_rate_limit
from storage_config import get_redis_storage

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('auction_bot.log'),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

bot = Bot(token=API_TOKEN)

# –ò—Å–ø–æ–ª—å–∑—É–µ–º Redis storage –≤–º–µ—Å—Ç–æ MemoryStorage
storage = get_redis_storage()
dp = Dispatcher(bot, storage=storage)

scheduler = AsyncIOScheduler(timezone=pytz.timezone(TIMEZONE))
db = AsyncDatabase(DB_URI)

active_timers: Dict[int, asyncio.Task] = {}

def is_admin(user_id: int) -> bool:
    return user_id in ADMIN_IDS

def format_dt(dt: datetime | None) -> str:
    if not dt:
        return "–Ω–µ –∑–∞–¥–∞–Ω–æ"
    return dt.strftime("%d.%m.%Y %H:%M")

async def format_remaining(end_time: datetime | None) -> str:
    if not end_time:
        return "---"
    now = datetime.now(pytz.timezone(TIMEZONE))
    delta = end_time - now
    if delta.total_seconds() <= 0:
        return "üõë –ó–∞–≤–µ—Ä—à—ë–Ω"
    total_seconds = int(delta.total_seconds())
    hours = total_seconds // 3600
    minutes = (total_seconds % 3600) // 60
    seconds = total_seconds % 60
    if hours > 0:
        return f"{hours} —á {minutes:02d} –º–∏–Ω"
    elif minutes > 0:
        return f"{minutes} –º–∏–Ω {seconds:02d} —Å–µ–∫"
    else:
        return f"{seconds} —Å–µ–∫"

# ========== STATES ==========
class BidState(StatesGroup):
    amount = State()

# ========== SECURITY MIDDLEWARE ==========
async def security_middleware(handler, event, data):
    """–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Å–ª–æ–π –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"""
    user_id = event.from_user.id if hasattr(event, 'from_user') else None
    
    # –õ–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
    if user_id and is_admin(user_id):
        logger.info(f"üëë –ê–¥–º–∏–Ω –¥–µ–π—Å—Ç–≤–∏–µ: {user_id} - {type(event).__name__}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if user_id:
        user = await db.get_user(user_id)
        if user and user.get('banned_until'):
            banned_until = user.get('banned_until')
            if isinstance(banned_until, str):
                banned_until = datetime.fromisoformat(banned_until)
            if banned_until > datetime.now():
                if hasattr(event, 'answer'):
                    await event.answer(f"üö´ –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –¥–æ {format_dt(banned_until)}")
                return
    
    return await handler(event, data)

# –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º middleware
dp.middleware.setup(security_middleware)

# ========== HANDLERS (–æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ –±—ã–ª–∏, –Ω–æ —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é) ==========

@dp.message_handler(commands=["start"])
async def cmd_start(message: types.Message):
    try:
        user_id = message.from_user.id
        user_name = message.from_user.full_name
        await db.upsert_user(user_id, user_name)

        user = await db.get_user(user_id)
        banned_text = ""
        if user and user.get('banned_until'):
            banned_until = user.get('banned_until')
            if isinstance(banned_until, str):
                banned_until = datetime.fromisoformat(banned_until)
            if banned_until > datetime.now():
                banned_text = f"\n\n‚ö†Ô∏è <b>–í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –¥–æ {format_dt(banned_until)}</b>"

        kb = InlineKeyboardMarkup(row_width=2)
        kb.add(
            InlineKeyboardButton("üèÜ –ê–∫—Ç–∏–≤–Ω—ã–µ –∞—É–∫—Ü–∏–æ–Ω—ã", callback_data="view_auctions"),
            InlineKeyboardButton("üíº –ú–æ–∏ –∞—É–∫—Ü–∏–æ–Ω—ã", callback_data="my_auctions"),
            InlineKeyboardButton("üìú –ü—Ä–∞–≤–∏–ª–∞", callback_data="help"),
            InlineKeyboardButton("üëë –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", callback_data="admin_menu")
        )

        welcome_text = (
            f"üëã <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {user_name}!</b>\n\n"
            f"üöÄ <i>–≠—Ç–æ –±–æ—Ç-–∞—É–∫—Ü–∏–æ–Ω ¬´–¶–µ–Ω–æ–ª–æ–≤–µ—Ä¬ª</i> - –∑–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã—Ö —Ç–æ—Ä–≥–∞—Ö "
            f"–∑–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã –ø–æ –≤—ã–≥–æ–¥–Ω—ã–º —Ü–µ–Ω–∞–º.{banned_text}\n\n"
            f"üéØ <b>–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:</b>"
        )

        await message.answer(welcome_text, reply_markup=kb, parse_mode="HTML")
        logger.info(f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} ({user_name}) –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞")

    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ /start: {e}")
        await message.answer("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

# [–û—Å—Ç–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—Å—Ç–∞—é—Ç—Å—è –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô - —Ç–∞–∫–∏–µ –∂–µ –∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º bot.py]
# –î–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞ –Ω–µ –∫–æ–ø–∏—Ä—É—é –∏—Ö –≤—Å–µ, –Ω–æ –æ–Ω–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ç–∞–∫–∏–º–∏ –∂–µ

# ... [–≤—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –í–°–ï –æ—Å—Ç–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ bot.py] ...

# ========== –ó–ê–ü–£–°–ö –ë–û–¢–ê ==========

async def on_startup(dispatcher: Dispatcher):
    await db.initialize()
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á
    scheduler.start()
    scheduler.add_job(check_and_start_lots, 'interval', minutes=5)
    scheduler.add_job(check_and_close_finished, 'interval', minutes=1)
    
    logger.info("üöÄ –ë–æ—Ç ¬´–¶–µ–Ω–æ–ª–æ–≤–µ—Ä¬ª –∑–∞–ø—É—â–µ–Ω —Å Redis storage!")
    
    # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞–º
    for admin_id in ADMIN_IDS:
        try:
            await bot.send_message(
                admin_id,
                "‚úÖ <b>–ë–æ—Ç ¬´–¶–µ–Ω–æ–ª–æ–≤–µ—Ä¬ª —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!</b>\n\n"
                f"‚è∞ –í—Ä–µ–º—è: {datetime.now().strftime('%d.%m.%Y %H:%M:%S')}\n"
                f"üì¢ –ö–∞–Ω–∞–ª: {AUCTION_CHANNEL}\n"
                f"üíæ –•—Ä–∞–Ω–∏–ª–∏—â–µ: Redis\n\n"
                "<i>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã</i>",
                parse_mode="HTML"
            )
        except Exception as e:
            logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ–¥–æ–º–∏—Ç—å –∞–¥–º–∏–Ω–∞ {admin_id}: {e}")

async def on_shutdown(dispatcher: Dispatcher):
    # –û—Ç–º–µ–Ω—è–µ–º –≤—Å–µ —Ç–∞–π–º–µ—Ä—ã
    for task in active_timers.values():
        task.cancel()
    if active_timers:
        await asyncio.gather(*active_timers.values(), return_exceptions=True)
    
    await db.close()
    await storage.close()
    logger.info("üõë –ë–æ—Ç ¬´–¶–µ–Ω–æ–ª–æ–≤–µ—Ä¬ª –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")

if __name__ == "__main__":
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ rate limiting
    setup_rate_limit(dp)
    
    logger.info(f"üöÄ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ ¬´–¶–µ–Ω–æ–ª–æ–≤–µ—Ä¬ª...")
    logger.info(f"üì¢ –ö–∞–Ω–∞–ª: {AUCTION_CHANNEL}")
    logger.info(f"üëë –ê–¥–º–∏–Ω—ã: {ADMIN_IDS}")
    logger.info(f"üíæ –•—Ä–∞–Ω–∏–ª–∏—â–µ: Redis")
    
    try:
        executor.start_polling(
            dp,
            skip_updates=True,
            on_startup=on_startup,
            on_shutdown=on_shutdown
        )
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞: {e}")
